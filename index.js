"use strict";
var Promise = require("bluebird");
var couchObj = require("../couchobject");
var rpj = require("request-promise-json");
function find(_id, couchdb) {
    return new Promise(function (resolve, reject) {
        rpj.get(couchdb + "/" + _id).then(function (obj) {
            resolve(obj);
        }).catch(function (err) {
            reject(err);
        });
    });
}
function update(obj, couchdb) {
    return new Promise(function (resolve, reject) {
        find(obj._id, couchdb).then(function (o) {
            obj._rev = o._rev;
            create(obj, couchdb).then(function () {
                resolve(true);
            }).catch(function (err) {
                reject(err);
            });
        });
    });
}
function create(obj, couchdb) {
    return new Promise(function (resolve, reject) {
        rpj.put(couchdb + "/" + obj._id, obj).then(function () {
            resolve(obj._id);
        }).catch(function (err) {
            reject(err);
        });
    });
}
var CouchManager = (function () {
    function CouchManager(conf) {
        this.couchdb = conf.couch;
        if (conf.class)
            this.class = conf.class;
        if (conf.serial)
            this.class = conf.serial;
        if (conf.apiVersion)
            this.apiVersion = conf.apiVersion;
    }
    CouchManager.prototype.create = function (obj) {
        var that = this;
        if (!obj.apiVersion && that.apiVersion)
            obj.apiVersion = that.apiVersion;
        return create(obj, this.couchdb);
    };
    CouchManager.prototype.update = function (obj) {
        var that = this;
        if (!obj.apiVersion && that.apiVersion)
            obj.apiVersion = that.apiVersion;
        return update(obj, this.couchdb);
    };
    CouchManager.prototype.find = function (_id) {
        return find(_id, this.couchdb);
    };
    CouchManager.prototype.gen = function (options) {
        var opt = {};
        var that = this;
        if (options) {
            if (options.class)
                opt.class = options.class;
            if (options.serial)
                opt.serial = options.serial;
            if (options.apiVersion)
                opt.apiVersion = options.apiVersion;
        }
        if (!opt.class && that.class)
            opt.class = that.class;
        if (!opt.serial && that.serial)
            opt.serial = that.serial;
        if (!opt.apiVersion && that.apiVersion)
            opt.apiVersion = that.apiVersion;
        return new couchObj(opt);
    };
    CouchManager.prototype.take = function (data, relation) {
        if (!data) {
            data = {};
        }
        var that = this;
        var startId;
        var stopId;
        if (data.startId) {
            startId = data.startId;
            if (data.stopId) {
                stopId = data.stopId;
            }
            else {
                stopId = false;
            }
        }
        else {
            if (that.class) {
                if (that.serial) {
                    startId = that.class + "_" + that.serial + "_";
                }
                else {
                    startId = that.class + "_00000_";
                }
            }
            else {
                if (that.serial) {
                    startId = "data_" + that.serial + "_";
                }
                else {
                    startId = "data_00000_";
                }
            }
            if (data.stopId) {
                stopId = data.stopId;
            }
            else {
                if (that.class) {
                    if (that.serial) {
                        stopId = that.class + "_" + that.serial + "_";
                    }
                    else {
                        stopId = that.class + "_00000_";
                    }
                }
                else {
                    if (that.serial) {
                        stopId = "data_" + that.serial + "_";
                    }
                    else {
                        stopId = "data_00000_99999999999";
                    }
                }
            }
        }
        var q;
        if (stopId) {
            q = that.couchdb + '/_all_docs?startkey="' + startId + '"&endkey=' + stopId;
        }
        else {
            q = that.couchdb + '/_all_docs?startkey="' + startId + '"';
        }
        console.log(q);
        return new Promise(function (resolve, reject) {
            rpj.get(q).then(function (objects) {
                console.log(objects);
                resolve(objects.rows);
                if (relation) {
                    resolve(that.relation(objects, relation));
                }
            }).catch(function (err) {
                reject(err);
            });
        });
    };
    CouchManager.prototype.relation = function (obj, relations) {
    };
    return CouchManager;
}());
module.exports = CouchManager;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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cyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuXG4vLyBpbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcblxuaW1wb3J0IGNvdWNoT2JqID0gcmVxdWlyZShcIi4uL2NvdWNob2JqZWN0XCIpOyAvL3RvIGJlIGNoYW5nZWQhISEhISEhISEhXG5cbmxldCBycGogPSByZXF1aXJlKFwicmVxdWVzdC1wcm9taXNlLWpzb25cIik7XG5cblxuXG5cblxuZnVuY3Rpb24gZmluZChfaWQ6IHN0cmluZywgY291Y2hkYjogc3RyaW5nKSB7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cbiAgICAgICAgcnBqLmdldChjb3VjaGRiICsgXCIvXCIgKyBfaWQpLnRoZW4oZnVuY3Rpb24ob2JqKSB7XG4gICAgICAgICAgICByZXNvbHZlKG9iaik7XG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0pXG5cbiAgICB9KVxuXG59XG5cblxuXG5cblxuZnVuY3Rpb24gdXBkYXRlKG9iaiwgY291Y2hkYjogc3RyaW5nKSB7XG5cblxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXG5cbiAgICAgICAgZmluZChvYmouX2lkLCBjb3VjaGRiKS50aGVuKGZ1bmN0aW9uKG86IGFueSkge1xuXG4gICAgICAgICAgICBvYmouX3JldiA9IG8uX3JldjtcblxuICAgICAgICAgICAgY3JlYXRlKG9iaiwgY291Y2hkYikudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgfSlcblxufVxuXG5cblxuZnVuY3Rpb24gY3JlYXRlKG9iaiwgY291Y2hkYjogc3RyaW5nKSB7XG5cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXG5cbiAgICAgICAgcnBqLnB1dChjb3VjaGRiICsgXCIvXCIgKyBvYmouX2lkLCBvYmopLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICByZXNvbHZlKG9iai5faWQpO1xuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9KVxuXG4gICAgfSlcblxuXG59XG5cbmludGVyZmFjZSBJZGVwZW5kcyB7XG4gICAgY2xhc3M6IHN0cmluZyxcbiAgICBtb3VudDogc3RyaW5nO1xuICAgIHJlbGF0aW9uPzogSXJlbGF0aW9uc1xufVxuaW50ZXJmYWNlIElyZWxhdGlvbnMge1xuICAgIGRlcGVuZGVudHM6IElkZXBlbmRlbnRzO1xuICAgIGRlcGVuZHM6IElkZXBlbmRzXG59XG5cbmludGVyZmFjZSBJZGVwZW5kZW50cyB7XG4gICAgY2xhc3M6IHN0cmluZyxcbiAgICBtb3VudDogc3RyaW5nO1xuICAgIHJlbGF0aW9uPzogSXJlbGF0aW9uc1xufVxuXG5jbGFzcyBDb3VjaE1hbmFnZXIge1xuICAgIGNvdWNoZGI6IHN0cmluZztcbiAgICBjbGFzczogc3RyaW5nO1xuICAgIHNlcmlhbDogc3RyaW5nO1xuICAgIGFwaVZlcnNpb246IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGNvbmY6IHsgY291Y2g6IHN0cmluZywgY2xhc3M/OiBzdHJpbmcsIHNlcmlhbD86IHN0cmluZywgYXBpVmVyc2lvbj86IHN0cmluZyB9KSB7XG4gICAgICAgIHRoaXMuY291Y2hkYiA9IGNvbmYuY291Y2g7XG4gICAgICAgIGlmIChjb25mLmNsYXNzKSB0aGlzLmNsYXNzID0gY29uZi5jbGFzcztcbiAgICAgICAgaWYgKGNvbmYuc2VyaWFsKSB0aGlzLmNsYXNzID0gY29uZi5zZXJpYWw7XG4gICAgICAgIGlmIChjb25mLmFwaVZlcnNpb24pIHRoaXMuYXBpVmVyc2lvbiA9IGNvbmYuYXBpVmVyc2lvbjtcbiAgICB9XG4gICAgXG4gICAgLy8gIG1hcHRvKHJlbGF0aW9ucyl7XG4gICAgICAgIFxuICAgIC8vICB9XG5cbiAgICBjcmVhdGUob2JqKSB7XG5cbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xuXG4gICAgICAgIGlmICghb2JqLmFwaVZlcnNpb24gJiYgdGhhdC5hcGlWZXJzaW9uKSBvYmouYXBpVmVyc2lvbiA9IHRoYXQuYXBpVmVyc2lvbjtcblxuXG4gICAgICAgIHJldHVybiBjcmVhdGUob2JqLCB0aGlzLmNvdWNoZGIpO1xuXG5cbiAgICB9XG5cbiAgICB1cGRhdGUob2JqKSB7XG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcbiAgICAgICAgaWYgKCFvYmouYXBpVmVyc2lvbiAmJiB0aGF0LmFwaVZlcnNpb24pIG9iai5hcGlWZXJzaW9uID0gdGhhdC5hcGlWZXJzaW9uXG5cbiAgICAgICAgcmV0dXJuIHVwZGF0ZShvYmosIHRoaXMuY291Y2hkYik7XG5cblxuICAgIH1cblxuXG5cbiAgICBmaW5kKF9pZCkge1xuXG4gICAgICAgIHJldHVybiBmaW5kKF9pZCwgdGhpcy5jb3VjaGRiKTtcblxuXG4gICAgfVxuXG4gICAgZ2VuKG9wdGlvbnM/OiB7IGNsYXNzPzogc3RyaW5nLCBzZXJpYWw/OiBzdHJpbmcsIGFwaVZlcnNpb24/OiBzdHJpbmcgfSkge1xuICAgICAgICBsZXQgb3B0ID0gPGNvdWNoT2JqPnt9O1xuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmNsYXNzKSBvcHQuY2xhc3MgPSBvcHRpb25zLmNsYXNzO1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2VyaWFsKSBvcHQuc2VyaWFsID0gb3B0aW9ucy5zZXJpYWxcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmFwaVZlcnNpb24pIG9wdC5hcGlWZXJzaW9uID0gb3B0aW9ucy5hcGlWZXJzaW9uXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW9wdC5jbGFzcyAmJiB0aGF0LmNsYXNzKSBvcHQuY2xhc3MgPSB0aGF0LmNsYXNzO1xuICAgICAgICBpZiAoIW9wdC5zZXJpYWwgJiYgdGhhdC5zZXJpYWwpIG9wdC5zZXJpYWwgPSB0aGF0LnNlcmlhbDtcbiAgICAgICAgaWYgKCFvcHQuYXBpVmVyc2lvbiAmJiB0aGF0LmFwaVZlcnNpb24pIG9wdC5hcGlWZXJzaW9uID0gdGhhdC5hcGlWZXJzaW9uXG5cbiAgICAgICAgcmV0dXJuIG5ldyBjb3VjaE9iaihvcHQpO1xuXG4gICAgfVxuXG4gICAgdGFrZShkYXRhPzogeyBudW1iZXI/OiBudW1iZXIsIG9mZnNldD86IG51bWJlciwgb3JkZXI/OiBzdHJpbmcsIHN0YXJ0SWQ/OiBzdHJpbmcsIHN0b3BJZD86IHN0cmluZywgc3RhcnRUaW1lPzogbnVtYmVyLCBzdG9wVGltZT86IG51bWJlciB9LCByZWxhdGlvbj86IElyZWxhdGlvbnMpIHtcbiAgICAgIGlmKCFkYXRhKXtcbiAgICAgICAgICBkYXRhPXt9O1xuICAgICAgfVxuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XG4gICAgICAgIGxldCBzdGFydElkO1xuICAgICAgICBsZXQgc3RvcElkO1xuICAgICAgICBpZiAoZGF0YS5zdGFydElkKSB7XG4gICAgICAgICAgICBzdGFydElkID0gZGF0YS5zdGFydElkXG4gICAgICAgICAgICBpZiAoZGF0YS5zdG9wSWQpIHtcbiAgICAgICAgICAgICAgICBzdG9wSWQgPSBkYXRhLnN0b3BJZFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdG9wSWQgPSBmYWxzZVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBpZiAodGhhdC5jbGFzcykge1xuICAgICAgICAgICAgICAgIGlmICh0aGF0LnNlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICBzdGFydElkID0gdGhhdC5jbGFzcyArIFwiX1wiICsgdGhhdC5zZXJpYWwgKyBcIl9cIlxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0SWQgPSB0aGF0LmNsYXNzICsgXCJfMDAwMDBfXCJcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoYXQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0SWQgPSBcImRhdGFfXCIgKyB0aGF0LnNlcmlhbCArIFwiX1wiXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRJZCA9IFwiZGF0YV8wMDAwMF9cIlxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIGlmIChkYXRhLnN0b3BJZCkge1xuICAgICAgICAgICAgICAgIHN0b3BJZCA9IGRhdGEuc3RvcElkXG4gICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoYXQuY2xhc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wSWQgPSB0aGF0LmNsYXNzICsgXCJfXCIgKyB0aGF0LnNlcmlhbCArIFwiX1wiXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wSWQgPSB0aGF0LmNsYXNzICsgXCJfMDAwMDBfXCJcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wSWQgPSBcImRhdGFfXCIgKyB0aGF0LnNlcmlhbCArIFwiX1wiXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wSWQgPSBcImRhdGFfMDAwMDBfOTk5OTk5OTk5OTlcIlxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcTtcblxuICAgICAgICBpZiAoc3RvcElkKSB7XG4gICAgICAgICAgICBxID0gdGhhdC5jb3VjaGRiICsgJy9fYWxsX2RvY3M/c3RhcnRrZXk9XCInICsgc3RhcnRJZCArICdcIiZlbmRrZXk9JyArIHN0b3BJZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHEgPSB0aGF0LmNvdWNoZGIgKyAnL19hbGxfZG9jcz9zdGFydGtleT1cIicgKyBzdGFydElkICsgJ1wiJztcbiAgICAgICAgfVxuY29uc29sZS5sb2cocSlcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgcnBqLmdldChxKS50aGVuKGZ1bmN0aW9uKG9iamVjdHMpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhvYmplY3RzKVxuICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0cy5yb3dzKTtcblxuICAgICAgICAgICAgICAgIGlmIChyZWxhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRoYXQucmVsYXRpb24ob2JqZWN0cywgcmVsYXRpb24pKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuXG4gICAgfVxuXG4gICAgcmVsYXRpb24ob2JqOiBhbnksIHJlbGF0aW9uczogSXJlbGF0aW9ucyk6IGFueSB7XG5cbiAgICB9XG5cbn1cblxuXG5leHBvcnQgPSBDb3VjaE1hbmFnZXIiXX0=
